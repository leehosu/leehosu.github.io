---
template: "post"
title: "ì¢Œì¶©ìš°ëŒ AWS EKS Nodegroup ì „í™˜ê¸°"
date: "2023-08-15 13:00"
slug: "aws-eks-ng"
keywords: "devops"
cover : './cover.png'
categories: 
    - Devops
    - Kubernetes
    - AWS
    - AWS EKS
    - AWS EC2
tags: 
    - Devops
    - Kubernetes
    - AWS
    - AWS EKS
    - AWS EC2
---

# ê°œìš”

í˜„ì¬ AWS EKSë¥¼ ì´ìš©í•˜ì—¬ K8s ë¥¼ êµ¬ì¶•í•˜ê³  ìš´ì˜í•˜ê³  ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ìµœê·¼ë“¤ì–´ ì‹ ê·œ ì„œë¹„ìŠ¤ë„ ëŸ°ì¹­í•˜ê³ , ë°°í¬í•´ì•¼ í•  Pod ìˆ˜ë„ ëŠ˜ì–´ë‚˜ê³ , ì—¬ëŸ¬ ê°€ì§€ devops ê´€ë ¨ podë¥¼ êµ¬ì¶•í•˜ê³  ì‹¶ì–´ í”„ë¡œì íŠ¸ë¡œ ì¼ì •ì„ ìˆ˜ë¦½í•˜ê³  ì§„í–‰í•˜ê³  ìˆë˜ ì™€ì¤‘ Podê°€ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ì§€ ì•ŠëŠ” í˜„ìƒì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤..!

ì°¾ì•„ë³´ë‹ˆ EKS Workernodeë¡œ ì‚¬ìš©ì¤‘ì¸ EC2 Instance ì˜ Memory ì˜ ìš©ëŸ‰ì´ ë¶€ì¡±í•˜ì—¬ Podë¥¼ ë„ìš¸ ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤.

# ì ì ˆí•œ EC2 Instance Typeì„ ì°¾ì•„ë³´ì!

ì œê°€ ì²˜ìŒ ê³ ë ¤í–ˆë˜ Typeì€ í˜„ì¬ì“°ê³  ìˆëŠ” ë‹¤ìŒ í¬ê¸°ì˜ EC2 ì˜€ìŠµë‹ˆë‹¤.

- As-Is :  t3.xlarge
- To-Be : t3.2xlarge

**íƒ€ì… ë¹„êµ**

|  | vCPU* | ë©”ëª¨ë¦¬(GiB) | ë„¤íŠ¸ì›Œí¬ ì„±ëŠ¥(Gbps)*** | ìµœëŒ€ Podìˆ˜ | ì‹œê°„ë‹¹ ìš”ê¸ˆ | í•œë‹¬ ìš”ê¸ˆ |
| --- | --- | --- | --- | --- | --- | --- |
| t3.xlarge | 4 | 16 | ìµœëŒ€ 5 | 58 | 0.208 USD | 200,524.46ì› |
| t3.2xlarge | 8 | 32 | ìµœëŒ€ 5 | 58 | 0.416USD | 401,048.92ì› |

í•˜ì§€ë§Œ,, íšŒì‚¬ ì…ì¥ì—ì„œ ë¹„ìš©ì´ ê³¼í•˜ë‹¤ëŠ” í”¼ë“œë°±ì´ ëŒì•„ì™”ê³  ëˆˆë¬¼ì„ ë¨¸ê¸ˆê³  ë‹¤ë¥¸ typeì„ ì°¾ê¸° ì‹œì‘í–ˆìŠµë‹ˆë‹¤.

ê°™ì€ CPU, Memoryë¥¼ í˜¸ìŠ¤íŒ… í•´ì£¼ëŠ” ê²ƒì„ ì¤‘ì ìœ¼ë¡œ ì°¾ë‹¤ê°€ t4g typeì„ ì°¾ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤..! 

**íƒ€ì… ë¹„êµ**

|  | vCPU* | ë©”ëª¨ë¦¬(GiB) | ìµœëŒ€ Podìˆ˜ | ì‹œê°„ë‹¹ ìš”ê¸ˆ | í•œë‹¬ ìš”ê¸ˆ |
| --- | --- | --- | --- | --- | --- |
| t3.xlarge | 4 | 16 | 58 | 0.208 USD | 200,524.46ì› |
| t3.2xlarge | 8 | 32 | 58 | 0.416USD | 401,048.92ì› |
| t4g.2xlarge | 8 | 32 | 58 | 0.3328USD | 320,833.85ì› |

# í•˜ì§€ë§Œ..!

ê·¸ë ‡ê²Œ t4g typeìœ¼ë¡œ ê²°ì •í•˜ê³  AWS EKSì—ì„œ ìƒˆë¡œìš´ node groupì„ ìƒì„±í•˜ëŠ” ë„ì¤‘ AMI ì´ë¯¸ì§€ê°€ ë‹¤ë¥¸ ê²ƒì„ í™•ì¸í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. t3ëŠ” `AL2_x86_64` ì¸ ë°˜ë©´ t4gëŠ” `AL2_ARM_64`ì˜€ìŠµë‹ˆë‹¤. 

ë³„ ë¬¸ì œ ì—†ê² ê±°ë‹ˆ.. ì‹¶ì—ˆì§€ë§Œ ê·¸ë˜ë„ ì¡°ì‚¬ë¥¼ í•´ë³´ì•˜ê³  gptëŠ” ì•„ë˜ì™€ ê°™ì€ ë‹µë³€ì„ ì£¼ì—ˆìŠµë‹ˆë‹¤.

## t3 vs t4g

> **[GPT]**
> #### T3 ëª¨ë¸
> - T3 ì¸ìŠ¤í„´ìŠ¤ íŒ¨ë°€ë¦¬ëŠ” "burstable" ì›Œí¬ë¡œë“œë¥¼ ìœ„í•´ ìµœì í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ëŠ” CPU ì‚¬ìš©ë¥ ì´ ë‚®ê³  ê°€ë” ë†’ì€ CPU í™œë™ì´ í•„ìš”í•œ ê²½ìš°ì— í•´ë‹¹í•©ë‹ˆë‹¤.
> - ì˜ˆë¥¼ ë“¤ì–´, ì›Œí¬ë¡œë“œê°€ ì¼ë°˜ì ìœ¼ë¡œ ë‚®ì€ CPU ë¶€í•˜ë¥¼ ê°€ì§€ë©° ê°€ë” íŠ¹ì • ì‹œì ì—ì„œ ë†’ì€ CPU ë¶€í•˜ë¥¼ ê²ªëŠ” ê²½ìš°, T3 ì¸ìŠ¤í„´ìŠ¤ íŒ¨ë°€ë¦¬ëŠ” ì´ëŸ¬í•œ ì›Œí¬ë¡œë“œì— ì í•©í•˜ë©° ë¹„ìš© íš¨ìœ¨ì ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
> - T3a ì¸ìŠ¤í„´ìŠ¤ì™€ ë‹¬ë¦¬, T3 ì¸ìŠ¤í„´ìŠ¤ëŠ” Skylake í”„ë¡œì„¸ì„œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
> 
> â†’ ê°€ë³€ì ì¸ CPU ì‚¬ìš©ëŸ‰ì„ ê°€ì§„ ì›Œí¬ë¡œë“œì— ìœ ìš©í•˜
> 
> #### T4g ëª¨ë¸
> - T4g ì¸ìŠ¤í„´ìŠ¤ íŒ¨ë°€ë¦¬ëŠ” ARM ê¸°ë°˜ì˜ AWS Graviton2 í”„ë¡œì„¸ì„œë¥¼ ì‚¬ìš©í•˜ì—¬ ë™ì‘í•©ë‹ˆë‹¤.
> - T4g ì¸ìŠ¤í„´ìŠ¤ëŠ” ê°€ê²© ëŒ€ë¹„ ì„±ëŠ¥ì„ ê°œì„ í•˜ë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.
> - ARM í”„ë¡œì„¸ì„œì˜ ì‚¬ìš©ìœ¼ë¡œ ì¸í•´ T4g ì¸ìŠ¤í„´ìŠ¤ëŠ” ì¼ë¶€ ì›Œí¬ë¡œë“œì—ì„œ ì¢‹ì€ ì„±ëŠ¥ì„ ë°œíœ˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
> 
> â†’ ARM ê¸°ë°˜ í”„ë¡œì„¸ì„œë¥¼ ì‚¬ìš©í•˜ì—¬ íŠ¹ì • ì›Œí¬ë¡œë“œì—ì„œ ì„±ëŠ¥ì„ í–¥ìƒ
> 

```jsx

AL2_ARM_64 (ARM 64ë¹„íŠ¸ ì•„í‚¤í…ì²˜):
- AL2_ARM_64ëŠ” ARM 64ë¹„íŠ¸ ì•„í‚¤í…ì²˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•˜ëŠ” Amazon Linux 2 ì¸ìŠ¤í„´ìŠ¤ ìœ í˜•ì…ë‹ˆë‹¤.
- ARM ì•„í‚¤í…ì²˜ëŠ” ì €ì „ë ¥ ë° íš¨ìœ¨ì ì¸ í”„ë¡œì„¸ì„œ ì•„í‚¤í…ì²˜ë¡œ, ëª¨ë°”ì¼ ë° ì„ë² ë””ë“œ ì‹œìŠ¤í…œì—ì„œ ì£¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.
- AL2_ARM_64 ì¸ìŠ¤í„´ìŠ¤ ìœ í˜•ì€ ARM í”„ë¡œì„¸ì„œë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹¤í–‰ë˜ë©°, ì»´í“¨íŒ… ë° ë©”ëª¨ë¦¬ ìš”êµ¬ ì‚¬í•­ì„ ì²˜ë¦¬í•˜ëŠ” ë° ìµœì í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤[1].

AL2_x86_64 (x86 64ë¹„íŠ¸ ì•„í‚¤í…ì²˜):
- AL2_x86_64ëŠ” x86 64ë¹„íŠ¸ ì•„í‚¤í…ì²˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•˜ëŠ” Amazon Linux 2 ì¸ìŠ¤í„´ìŠ¤ ìœ í˜•ì…ë‹ˆë‹¤.
- x86 ì•„í‚¤í…ì²˜ëŠ” ì£¼ë¥˜ ì»´í“¨í„° ì‹œìŠ¤í…œì—ì„œ ë§ì´ ì‚¬ìš©ë˜ë©°, Intel ë° AMD í”„ë¡œì„¸ì„œë¥¼ í¬í•¨í•œ ë‹¤ì–‘í•œ í”„ë¡œì„¸ì„œì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.
- AL2_x86_64 ì¸ìŠ¤í„´ìŠ¤ ìœ í˜•ì€ x86 64ë¹„íŠ¸ ì•„í‚¤í…ì²˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹¤í–‰ë˜ë©°, ë‹¤ì–‘í•œ ì›Œí¬ë¡œë“œ ë° ì‘ìš© í”„ë¡œê·¸ë¨ì„ ì²˜ë¦¬í•˜ëŠ” ë° ìµœì í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
```

ì•„í‚¤í…ì²˜ê°€ ë‹¤ë¥´ë‹¤ë³´ë‹ˆ ì—¬ëŸ¬ ì´ìŠˆê°€ ìƒê¸¸ ê²ƒ ê°™ì•˜ì§€ë§Œ ë¬´ìŠ¨ ë¬¸ì œê°€ ìˆì„ê¹Œ ê¶ê¸ˆí–ˆìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ ì¼ë‹¨ í•´ë‹¹ nodeì—ë§Œ íŒŒë“œë¥¼ í•˜ë‚˜ ìƒì„±í•´ì„œ í…ŒìŠ¤íŠ¸ í•´ë³´ì ìƒê°ìœ¼ë¡œ êµ¬ì„±ì„ ì´ì–´ê°”ìŠµë‹ˆë‹¤.

í•´ë‹¹ nodeì— labelì„ ì£¼ì—ˆê³ , test pod manifast fileì— labelSelectorë¥¼ ì´ìš©í•˜ì—¬ í•´ë‹¹ ë…¸ë“œì—ë§Œ Podê°€ ë„ì–´ì§€ê²Œ êµ¬ì„±í•˜ì˜€ê³  ë°”ë¡œ ë°°í¬í•´ë³´ì•˜ìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ ì•„ë‹ˆë‚˜ ë‹¤ë¥¼ê¹Œ Podê°€ ìƒì„±ë˜ì§€ ì•Šê³  `CrashBackOff`ë¡œ ê³„ì† restartê°€ ë˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤..

![pod-error](./pod-error.png)

ë ìš©?!! `exec format error`?! 

í•´ë‹¹ ì˜¤ë¥˜ëŠ” ì²˜ìŒ ë³´ëŠ” ë‚´ìš©ì´ì—ˆê³  ë°”ë¡œ êµ¬ê¸€ë§ì„ í•´ë´¤ìŠµë‹ˆë‹¤.

![stackoverflow](./stackoverflow.png)

`x86`ìœ¼ë¡œ buildëœ Docker ImageëŠ” `arm64/aarch64` ì•„í‚¤í…ì²˜ ì„œë²„ì—ì„œëŠ” ë„ìš¸ ìˆ˜ ì—†ë‹¤â€¦ ëŠ” ë‚´ìš©ì˜ ë‹µë³€ì´ì—ˆê³  [Docker](https://docs.docker.com/build/building/multi-platform/) ê³µì‹ í˜ì´ì§€ë¥¼ ë“¤ì–´ê°€ì„œ í™•ì¸í•´ë³´ë‹ˆ íŠ¹ì • ì˜µì…˜ì„ ì£¼ì–´ì„œ Docker Image buildë¥¼ í•˜ë©´ ëœë‹¤ ë¼ëŠ” ë¬¸ì„œë¥¼ í™•ì¸í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.



í•˜ì§€ë§Œ ì´ë¯¸ ì„œë¹„ìŠ¤ì¤‘ì¸ íŒŒë“œë“¤ì´ ë§ê³  ì´ë¯¸ì§€ ë¹Œë“œ í˜•ì‹ì„ ë°”ê¾¸ê¸°ì—” ê³µìˆ˜ê°€ ë§ì´ ë“œëŠ” ì‘ì—…ì´ì—ˆê³ , ì¶”í›„ ì„œë¹„ìŠ¤ê°€ ë” ëŠ˜ì–´ë‚  ì‹œì— `x86` ì•„í‚¤í…ì²˜ì˜ EC2ë¥¼ ì‚¬ìš©í•  ê°€ëŠ¥ì„±ì´ ë‹¤ë¶„í•˜ì—¬ ë‹¤ë¥¸ ëŒ€ì•ˆì„ ëª¨ìƒ‰í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.  

# ëŒ€ì•ˆ

í˜„ì¬ ìš´ì˜ì¤‘ì¸ ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ë„ì–´ì ¸ ìˆëŠ” ê¸°ì¡´ nodeì˜ memoryë¥¼ ëŠ˜ë ¤ ë” ë§ì€ podë¥¼ ë„ìš°ë ¤ëŠ” ê²ƒì´ ëª©ì ì´ì—ˆë˜í„°ë¼ **ê°™ì€ ì•„í‚¤í…ì²˜ì˜ EC2 instance**ê°€ ì „ì œì˜€ìŠµë‹ˆë‹¤.

ê·¸ë˜ì„œ ê²°êµ­ ë‹¤ë¥¸ EC2 instance typeì„ ì°¾ì•„ë³´ê²Œ ë˜ì—ˆê³  `t3a`ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤..!

### t3a ëª¨ë¸

> **[GPT]**
> #### T3a ëª¨ë¸
> 
> - T3a ì¸ìŠ¤í„´ìŠ¤ íŒ¨ë°€ë¦¬ëŠ” T3ì™€ ìœ ì‚¬í•œ íŠ¹ì„±ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ í”„ë¡œì„¸ì„œê°€ ë‹¤ë¦…ë‹ˆë‹¤. T3aëŠ” AMD EPYC 7000 ì‹œë¦¬ì¦ˆ í”„ë¡œì„¸ì„œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
> - T3a ëª¨ë¸ì€ ë¹„ìŠ·í•œ ì›Œí¬ë¡œë“œì— ëŒ€í•´ T3ì™€ ë¹„ìŠ·í•œ ì„±ëŠ¥ì„ ì œê³µí•˜ì§€ë§Œ, í”„ë¡œì„¸ì„œì— ë”°ë¥¸ ì°¨ì´ê°€ ìˆìŠµë‹ˆë‹¤.

### íƒ€ì… ì •ë¦¬

| To-Be | vCPU* | ë©”ëª¨ë¦¬(GiB) | ìµœëŒ€ Podìˆ˜ | ì‹œê°„ë‹¹ ìš”ê¸ˆ | í•œë‹¬ ìš”ê¸ˆ | ìµœì¢… ê¸ˆì•¡ |
| --- | --- | --- | --- | --- | --- | --- |
| t3.2xlarge | 8 | 32 | 58 | 0.416USD | 304.84 USD | 401,048.92ì› |
| t4g.2xlarge | 8 | 32 | 58 | 0.3328 USD | 242.94 USD | 320,833.85ì› |
| t3a.2xlarge | 8 | 32 | 58 | 0.3744 USD | 273.31 USD | 360,941.39ì› |

## ë˜ ë‹¤ë¥¸ ë¬¸ì œ..!

![eks](./eks.png)

t3 ëª¨ë¸ì—ì„œ t3a ëª¨ë¸ë¡œ ë°”ê¾¸ë©´ì„œ ê¸°ì¡´ nodeì— ë„ì–´ì ¸ ìˆëŠ” Podë“¤ì„ ì˜®ê¸°ëŠ” drainì„ ì§„í–‰í–ˆëŠ”ë°, t3a ëª¨ë¸ì˜ ë…¸ë“œ ê·¸ë£¹ ìƒíƒœê°€ ì €í•˜ë¨ ì´ë¼ê³  í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.

![eks-detail](./eks-detail.png)

ë‘ë‘¥â€¦!

AWS EC2ëŠ” Instance Typeë³„ë¡œ ê°€ìš© ì˜ì—­ì´ ì •í•´ì ¸ìˆìŠµë‹ˆë‹¤.

- ê°€ìš© ì˜ì—­: `ap-northeast-2a`, `ap-northeast-2c`
    - t2, t3a, c4 ê³„ì—´ ë“±
- ê°€ìš© ì˜ì—­: `ap-northeast-2a`, `ap-northeast-2b`, `ap-northeast-2c`, `ap-northeast-2d`
    - t3, c5 ê³„ì—´ ë“±
- ê°€ìš© ì˜ì—­: `ap-northeast-2a`, `ap-northeast-2b`, `ap-northeast-2c`
    - t3, c5 ê³„ì—´ ë“±
- ê°€ìš© ì˜ì—­: `ap-northeast-2a,` `ap-northeast-2d`
    - mac1.metal
- ê°€ìš© ì˜ì—­: `ap-northeast-2d`
    - t3, c5 ê³„ì—´ ë“±
- ê°€ìš© ì˜ì—­: `ap-northeast-2c`
    - t2, t3, c4, c5 ê³„ì—´ ë“±

ë˜ ë‹¤ë¥¸ í™•ì¸ ë°©ë²•ìœ¼ë¡œëŠ” ì•„ë˜ì˜ ëª…ë ¹ì–´ë¥¼ ì´ìš©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

```bash
$ aws ec2 describe-instance-type-offerings \
    --location-type availability-zone \
    --filters Name=instance-type,Values=**t3a.*** \
    --region ap-northeast-2 --output table
```

![az](./az.png)

ê·¸ë ‡ê¸°ì— í˜„ì¬ ì‘ì—…í•œ Typeì¸ t3aëŠ” `ap-northeast-2a`, `ap-northeast-2c` ì˜ì—­ì—ì„œë§Œ EC2 Instanceë¥¼ ìƒì„±í•  ìˆ˜ ìˆì—ˆì§€ë§Œ nodegroupì„ ìƒì„±í•  ë•Œ `ap-northeast-2b`, `ap-northeast-2d`ë„ ì¶”ê°€ë¥¼ í•´ë†”ì„œ ë°œìƒí•œ ì´ìŠˆì˜€ìŠµë‹ˆë‹¤!

ì¦‰, `ap-northeast-2b`, `ap-northeast-2d` ì˜ì—­ì„ ì œì™¸í•˜ê³  node groupì„ ìƒì„±í•´ì£¼ì‹œë©´ í•´ê²°ë©ë‹ˆë‹¤..!

# ë§ˆì¹˜ë©°

AWS EC2ëŠ” typeë³„ë¡œ ê°ê°ì˜ íŠ¹ì„±ì´ ìˆìŠµë‹ˆë‹¤. ì´ë²ˆ ì‘ì—…ì„ í†µí•´ AWS EC2ì˜ typeë³„ë¡œ ì–´ë–¤ íŠ¹ì„±ì´ ìˆëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆëŠ” ê°’ì§„ ê²½í—˜ì´ì—ˆìŠµë‹ˆë‹¤.ğŸ˜‚

ì´ëŸ¬í•œ ê²½í—˜ì„ í† ëŒ€ë¡œ í˜„ì¬ ìš´ì˜ì„œë²„ëŠ” ë¬¸ì œì—†ì´ ì˜ ëŒì•„ê°€ê³  ìˆìŠµë‹ˆë‹¤ ğŸ˜ğŸ˜ğŸ˜